image: Visual Studio 2019

platform:
  - x64

environment:
  matrix:
    - PYTHON: "C:\\Python38-x64"

artifacts:
  - path: build-windows.zip

build: off

init:
  - "SET PATH=%PYTHON%;%PYTHON%\\Scripts;%PATH%"
  - python -m pip install --upgrade pip
  - python -m pip install numpy

install:
  - '"C:\Program Files (x86)\Microsoft Visual Studio\2019\Community\VC\Auxiliary\Build\vcvars64.bat"'
  - nmake libtorrent
  - set BOOST_ROOT=C:\Libraries\boost_1_73_0
  - set BOOST_BUILD_PATH=%BOOST_ROOT%\tools\build
  - (cd %BOOST_ROOT% && dir && .\bootstrap.bat)
  - (cd %BOOST_ROOT% && .\bootstrap.bat)
  - echo using msvc ; >>%HOMEDRIVE%%HOMEPATH%\user-config.jam
  - (cd libtorrent/bindings/python && b2 release --debug-configuration crypto=openssl cxxstd=17 python=3.8 libtorrent-link=static boost-link=static)
  - (cd libtorrent/bindings/python && dir)

test_script:
  - python test.py

after_test:
  - 7z a build-windows.zip lib/__init__.py lib/libtorrent.lib lib/libtorrent.pyd __init__.py TorrentPlugin.py AlertEncoder.py test.py
  - dir

deploy:
  provider: GitHub
  auth_token:
    secure: 6eX2olaIxe4TsfETod+SYOyDsIKwmDivjirb7RPvl/Zd4zYW3dzGr4MieJ2BP89P # your encrypted token from GitHub
  artifact: build-windows.zip
  prerelease: true
  force_update: true
  on:
    appveyor_repo_tag: true        # deploy on tag push only
