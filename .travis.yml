matrix:
    include:
      - os: linux
        language: cpp
        compiler: gcc
        dist: focal
        sudo: true
        addons:
          apt:
            update: true
            packages:
              - g++-9
              - gcc-9
              - python3.9          
        install:
          - ls -l /usr/bin/python*
          - update-alternatives --set python /usr/bin/python3.9
          - python --version
          - make boost
          - make libtorrent
          - export BOOST_BUILD_PATH=${PWD}/boost_1_74_0/tools/build
          - export BOOST_ROOT=${PWD}/boost_1_74_0
          - cd libtorrent/bindings/python && ../../../boost_1_74_0/b2 release --debug-configuration crypto=openssl cxxstd=17 python=3.9 libtorrent-link=static boost-link=static
          - cp libtorrent/bindings/python/bin/gcc-9/release/crypto-openssl/cxxstd-17-iso/libtorrent-python-pic-on/python-3.9/libtorrent.so lib/

      - os: osx
        osx_image: xcode12.5
        language: generic
        sudo: true
        addons:
          homebrew:
            packages:
            - openssl@1.1
            - boost-python3
            - boost-build
        install:
          - ls -l /usr/bin/python*
          - ln -s -f /usr/local/bin/python3.9 /usr/local/bin/python
          - python --version
          - make libtorrent
          - cd libtorrent/bindings/python && b2 release --debug-configuration crypto=openssl cxxstd=17 python=3.9 libtorrent-link=static boost-link=static
          - cp libtorrent/bindings/python/bin/darwin-12.0.5/release/crypto-openssl/cxxstd-17-iso/libtorrent-python-pic-on/python-3.9/libtorrent.so lib/

script:
  - python3 test.py

before_deploy:
  - zip build-$TRAVIS_OS_NAME.zip lib/__init__.py lib/libtorrent.so __init__.py TorrentPlugin.py AlertEncoder.py test.py
deploy:
  provider: releases
  skip_cleanup: true
  api_key:
    secure: $GH_TOKEN
  file:
    - build-$TRAVIS_OS_NAME.zip
  on:
    tags: true
