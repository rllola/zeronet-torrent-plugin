language: generic
matrix:
    include:
      - os: linux
        dist: trusty
        sudo: true
        before_install:
          - sudo apt purge cmake
          - wget https://cmake.org/files/v3.12/cmake-3.12.1-Linux-x86_64.tar.gz
          - tar -xvf cmake-3.12.1-Linux-x86_64.tar.gz
          - cd cmake-3.12.1-Linux-x86_64
          - sudo cp -r bin /usr/
          - sudo cp -r share /usr/
          - sudo cp -r doc /usr/share/
          - sudo cp -r man /usr/share/
          - cd ..
          - sudo rm -r cmake-3.12.1-Linux-x86_64
        addons:
          apt:
            update: true
            sources:
              - george-edison55-precise-backports
              - ubuntu-toolchain-r-test
            packages:
              - python-dev
              - python-all
              - python-all-dev
              - python-gevent
              - python-greenlet
              - python-minimal
              - python-msgpack
              - python-wheel
              - g++-7
        env:
          - MATRIX_EVAL="CC=gcc-7 && CXX=g++-7"
      - os: osx
        sudo: true

before_install:
  - eval "${MATRIX_EVAL}"
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then sudo pip install conan; else pip install --user conan; fi
  - sudo pip install urllib3[secure]
  - conan remote add libtorrent https://api.bintray.com/conan/rllola80/Libtorrent
install:
  - conan install --build=missing .
  - conan build .
script:
  - python test.py

before_deploy:
  - zip build-$TRAVIS_OS_NAME.zip lib/__init__.py lib/libtorrent.so src/* __init__.py TorrentPlugin.py AlertEncoder.py test.py
deploy:
  provider: releases
  skip_cleanup: true
  api_key:
    secure: $GH_TOKEN
  file:
    - build-$TRAVIS_OS_NAME.zip
  on:
    tags: true
